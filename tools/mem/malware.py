"""
MemProcFS 恶意检测工具 (2个)
32. mem_findevil - 综合恶意检测
33. mem_yara - YARA扫描
"""

from core.loader import get_vmm
import csv
import io


def register_mem_malware_tools(mcp):
    """注册 MemProcFS 恶意检测工具"""
    
    @mcp.tool()
    def mem_findevil(mempath: str) -> dict:
        """
        [MemProcFS #32] 综合恶意检测 (FindEvil)
        
        Args:
            mempath: 内存镜像文件路径
        
        Returns:
            恶意检测结果
        """
        try:
            vmm = get_vmm(mempath)
            findings = []
            
            # 读取 findevil.csv
            try:
                findevil_data = vmm.vfs.read("/forensic/csv/findevil.csv")
                if findevil_data:
                    csv_reader = csv.DictReader(io.StringIO(findevil_data.decode('utf-8', errors='replace')))
                    for row in csv_reader:
                        findings.append(row)
            except:
                pass
            
            # 统计各类型发现
            stats = {}
            for finding in findings:
                finding_type = finding.get('Type', finding.get('type', 'Unknown'))
                stats[finding_type] = stats.get(finding_type, 0) + 1
            
            return {
                "success": True,
                "count": len(findings),
                "statistics": stats,
                "data": findings
            }
        except Exception as e:
            return {"success": False, "error": str(e)}
    
    @mcp.tool()
    def mem_yara(mempath: str) -> dict:
        """
        [MemProcFS #33] YARA 规则扫描结果
        
        Args:
            mempath: 内存镜像文件路径
        
        Returns:
            YARA 扫描匹配结果
        """
        try:
            vmm = get_vmm(mempath)
            matches = []
            
            # 读取 yara.csv
            try:
                yara_data = vmm.vfs.read("/forensic/csv/yara.csv")
                if yara_data:
                    csv_reader = csv.DictReader(io.StringIO(yara_data.decode('utf-8', errors='replace')))
                    for row in csv_reader:
                        matches.append(row)
            except:
                pass
            
            # 尝试读取详细 yara.txt
            yara_detail = None
            try:
                yara_txt = vmm.vfs.read("/forensic/findevil/yara.txt")
                if yara_txt:
                    yara_detail = yara_txt.decode('utf-8', errors='replace')
            except:
                pass
            
            return {
                "success": True,
                "count": len(matches),
                "data": matches,
                "detail": yara_detail
            }
        except Exception as e:
            return {"success": False, "error": str(e)}
