"""
Volatility 2 恶意代码检测工具 (6个)
72. vol2_malfind - 代码注入检测
73. vol2_malfinddeep - 深度恶意检测
74. vol2_apihooks - API钩子检测
75. vol2_apihooksdeep - 深度钩子检测
76. vol2_ldrmodules - 隐藏DLL检测
77. vol2_hollowfind - 进程镂空检测
"""

from typing import Optional
from core.vol2_runner import Vol2Runner


def register_vol2_malware_tools(mcp):
    """注册 Volatility 2 恶意代码检测工具"""
    
    @mcp.tool()
    def vol2_malfind(mempath: str, profile: Optional[str] = None, pid: Optional[int] = None) -> dict:
        """
        [Vol2 #72] 代码注入检测 (malfind)
        
        检测具有 RWX 权限且包含 PE 头的可疑内存区域
        
        Args:
            mempath: 内存镜像文件路径
            profile: Windows Profile
            pid: 进程ID (可选)
        
        Returns:
            可疑代码注入
        """
        try:
            runner = Vol2Runner(mempath, profile)
            if not profile:
                runner.get_profile()
            
            extra_args = ["-p", str(pid)] if pid else None
            return runner.run_plugin("malfind", extra_args=extra_args)
        except Exception as e:
            return {"success": False, "error": str(e)}
    
    @mcp.tool()
    def vol2_malfinddeep(mempath: str, profile: Optional[str] = None) -> dict:
        """
        [Vol2 #73] 深度恶意代码检测 (扩展插件)
        
        Args:
            mempath: 内存镜像文件路径
            profile: Windows Profile
        
        Returns:
            深度恶意检测结果
        """
        try:
            runner = Vol2Runner(mempath, profile)
            if not profile:
                runner.get_profile()
            return runner.run_plugin("malfinddeep")
        except Exception as e:
            return {"success": False, "error": str(e)}
    
    @mcp.tool()
    def vol2_apihooks(mempath: str, profile: Optional[str] = None, pid: Optional[int] = None) -> dict:
        """
        [Vol2 #74] API 钩子检测
        
        检测进程中的 API 钩子 (IAT, EAT, Inline hooks)
        
        Args:
            mempath: 内存镜像文件路径
            profile: Windows Profile
            pid: 进程ID (可选)
        
        Returns:
            API 钩子列表
        """
        try:
            runner = Vol2Runner(mempath, profile)
            if not profile:
                runner.get_profile()
            
            extra_args = ["-p", str(pid)] if pid else None
            return runner.run_plugin("apihooks", extra_args=extra_args)
        except Exception as e:
            return {"success": False, "error": str(e)}
    
    @mcp.tool()
    def vol2_apihooksdeep(mempath: str, profile: Optional[str] = None) -> dict:
        """
        [Vol2 #75] 深度 API 钩子检测 (扩展插件)
        
        Args:
            mempath: 内存镜像文件路径
            profile: Windows Profile
        
        Returns:
            深度钩子检测结果
        """
        try:
            runner = Vol2Runner(mempath, profile)
            if not profile:
                runner.get_profile()
            return runner.run_plugin("apihooksdeep")
        except Exception as e:
            return {"success": False, "error": str(e)}
    
    @mcp.tool()
    def vol2_ldrmodules(mempath: str, profile: Optional[str] = None, pid: Optional[int] = None) -> dict:
        """
        [Vol2 #76] 隐藏 DLL 检测 (LDR 模块交叉检查)
        
        通过比较三个 PEB 链表检测隐藏/未链接的 DLL
        
        Args:
            mempath: 内存镜像文件路径
            profile: Windows Profile
            pid: 进程ID (可选)
        
        Returns:
            LDR 模块检测结果 (False 表示可能隐藏)
        """
        try:
            runner = Vol2Runner(mempath, profile)
            if not profile:
                runner.get_profile()
            
            extra_args = ["-p", str(pid)] if pid else None
            return runner.run_plugin("ldrmodules", extra_args=extra_args)
        except Exception as e:
            return {"success": False, "error": str(e)}
    
    @mcp.tool()
    def vol2_hollowfind(mempath: str, profile: Optional[str] = None) -> dict:
        """
        [Vol2 #77] 进程镂空检测 (社区插件)
        
        检测 Process Hollowing 攻击
        
        Args:
            mempath: 内存镜像文件路径
            profile: Windows Profile
        
        Returns:
            进程镂空检测结果
        """
        try:
            runner = Vol2Runner(mempath, profile)
            if not profile:
                runner.get_profile()
            return runner.run_plugin("hollowfind")
        except Exception as e:
            return {"success": False, "error": str(e)}
