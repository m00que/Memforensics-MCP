"""
Volatility 3 恶意代码检测工具 (6个) ⭐最强
147-152
"""

from typing import Optional
from core.vol3_runner import Vol3Runner


def register_vol3_malware_tools(mcp):
    """注册 Volatility 3 恶意代码检测工具"""
    
    @mcp.tool()
    def vol3_malfind(mempath: str, pid: Optional[int] = None) -> dict:
        """
        [Vol3 #147] 代码注入检测
        
        Args:
            mempath: 内存镜像文件路径
            pid: 进程ID (可选)
        
        Returns:
            可疑代码注入
        """
        try:
            runner = Vol3Runner(mempath)
            extra_args = ["--pid", str(pid)] if pid else None
            return runner.run_plugin("windows.malfind", extra_args=extra_args)
        except Exception as e:
            return {"success": False, "error": str(e)}
    
    @mcp.tool()
    def vol3_hollowprocesses(mempath: str) -> dict:
        """
        [Vol3 #148] ⭐ 进程镂空检测 (Vol3 独有)
        
        检测 Process Hollowing 攻击
        
        Args:
            mempath: 内存镜像文件路径
        
        Returns:
            进程镂空检测结果
        """
        try:
            runner = Vol3Runner(mempath)
            return runner.run_plugin("windows.hollowprocesses")
        except Exception as e:
            return {"success": False, "error": str(e)}
    
    @mcp.tool()
    def vol3_processghosting(mempath: str) -> dict:
        """
        [Vol3 #149] ⭐ 进程幽灵检测 (Vol3 独有)
        
        检测 Process Ghosting 攻击
        
        Args:
            mempath: 内存镜像文件路径
        
        Returns:
            进程幽灵检测结果
        """
        try:
            runner = Vol3Runner(mempath)
            return runner.run_plugin("windows.processghosting")
        except Exception as e:
            return {"success": False, "error": str(e)}
    
    @mcp.tool()
    def vol3_skeleton_key(mempath: str) -> dict:
        """
        [Vol3 #150] ⭐ 骨架密钥检测 (Vol3 独有)
        
        检测域控制器上的 Skeleton Key 攻击
        
        Args:
            mempath: 内存镜像文件路径
        
        Returns:
            骨架密钥检测结果
        """
        try:
            runner = Vol3Runner(mempath)
            return runner.run_plugin("windows.skeleton_key_check")
        except Exception as e:
            return {"success": False, "error": str(e)}
    
    @mcp.tool()
    def vol3_direct_syscalls(mempath: str) -> dict:
        """
        [Vol3 #151] ⭐ 直接系统调用检测 (Vol3 独有)
        
        检测绕过 NTDLL 的直接系统调用 (EDR 逃逸技术)
        
        Args:
            mempath: 内存镜像文件路径
        
        Returns:
            直接系统调用检测结果
        """
        try:
            runner = Vol3Runner(mempath)
            return runner.run_plugin("windows.direct_system_calls")
        except Exception as e:
            return {"success": False, "error": str(e)}
    
    @mcp.tool()
    def vol3_indirect_syscalls(mempath: str) -> dict:
        """
        [Vol3 #152] ⭐ 间接系统调用检测 (Vol3 独有)
        
        检测通过其他模块进行的间接系统调用
        
        Args:
            mempath: 内存镜像文件路径
        
        Returns:
            间接系统调用检测结果
        """
        try:
            runner = Vol3Runner(mempath)
            return runner.run_plugin("windows.indirect_system_calls")
        except Exception as e:
            return {"success": False, "error": str(e)}
